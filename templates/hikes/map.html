{% extends "base.html" %}

{% block title %}All Hikes Map - Hike Guide{% endblock %}

{% block head %}
<style>
    /* Remove bottom padding from the page wrapper so map can sit flush */
    main > div { padding-bottom: 0 !important; }

    /* Compact toolbar above the map â€” matches other page headers in feel */
    #map-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 0 0.75rem;
        gap: 0.75rem;
        flex-shrink: 0;
    }
    #map-toolbar .toolbar-title {
        font-family: 'Outfit', system-ui, sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        color: #111827;
        letter-spacing: -0.02em;
        line-height: 1.1;
    }
    #map-toolbar .toolbar-count {
        font-size: 0.8125rem;
        color: #9ca3af;
        font-weight: 400;
        display: block;
    }

    /* Map fills remaining viewport height:
       21px dev-banner + 56px navbar + 24px top-padding + 80px toolbar â‰ˆ 181px */
    #map-container {
        height: calc(100dvh - 181px);
        min-height: 400px;
        display: flex;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 1px 6px rgba(0,0,0,0.08);
        border: 1px solid #e5e1da;
        margin-bottom: 1.5rem;
    }
    #all-hikes-map {
        flex: 1;
        min-width: 0;
        height: 100%;
    }
    #hike-sidebar {
        width: 320px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #e5e1da;
        background: #fff;
    }
    #hike-sidebar-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e5e1da;
        background: #fafaf7;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
    }
    #hike-sidebar-header h2 {
        font-size: 0.8125rem;
        font-weight: 700;
        color: #1a1a1a;
        margin: 0;
    }
    #visible-count {
        font-size: 0.7rem;
        color: #aaa;
        background: #f3ede5;
        padding: 0.15rem 0.5rem;
        border-radius: 99px;
        white-space: nowrap;
    }
    #hike-list {
        flex: 1;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #d1cdc5 transparent;
    }
    #hike-list::-webkit-scrollbar { width: 4px; }
    #hike-list::-webkit-scrollbar-track { background: transparent; }
    #hike-list::-webkit-scrollbar-thumb { background: #d1cdc5; border-radius: 3px; }
    #hike-list::-webkit-scrollbar-thumb:hover { background: #9e9a92; }

    .hike-card {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f3ede5;
        cursor: pointer;
        transition: background 0.15s ease;
        user-select: none;
        display: flex;
        align-items: flex-start;
        gap: 0.625rem;
    }
    .hike-card:hover { background: #f8faf7; }
    .hike-card.highlighted {
        background: #f0fdf4;
        box-shadow: inset 3px 0 0 #2d7e41;
    }
    .hike-card .color-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-top: 3px;
        border: 2px solid #fff;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.12);
    }
    .hike-card .card-body { flex: 1; min-width: 0; }
    .hike-card .card-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #1a1a1a;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .hike-card .card-location {
        font-size: 0.7rem;
        color: #aaa;
        margin-top: 0.15rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .hike-card .card-meta {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        font-size: 0.7rem;
        color: #999;
        margin-top: 0.3rem;
    }
    .hike-card .card-arrow {
        color: #ccc;
        flex-shrink: 0;
        margin-top: 2px;
        transition: color 0.15s;
    }
    .hike-card:hover .card-arrow { color: #2d7e41; }
    .hike-card.hidden-viewport { display: none; }

    #empty-state {
        display: none;
        padding: 2.5rem 1.5rem;
        text-align: center;
    }

    @media (max-width: 768px) {
        #map-container { flex-direction: column; border-radius: 0.5rem; }
        #all-hikes-map { height: 55vh; min-height: 280px; flex: none; }
        #hike-sidebar { width: 100%; flex: 1; min-height: 200px; border-left: none; border-top: 1px solid #e5e1da; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Compact toolbar -->
<div id="map-toolbar">
    <div class="min-w-0">
        <h1 class="toolbar-title">All Hikes Map</h1>
        <p class="toolbar-count mt-0.5">{{ hike_markers|length }} hike{{ 's' if hike_markers|length != 1 else '' }} Â· click a trail or card to explore</p>
    </div>
    <div class="flex items-center gap-2 flex-shrink-0">
        <a href="/hikes" id="nav-explore"
           class="inline-flex items-center gap-1.5 rounded-xl bg-white px-4 py-2 text-sm font-semibold text-gray-600 ring-1 ring-sand-200 hover:bg-sand-50 transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"/></svg>
            List
        </a>
        <a href="/hikes/new"
           class="inline-flex items-center gap-1.5 rounded-xl bg-forest-600 px-4 py-2 text-sm font-bold text-white shadow-sm hover:bg-forest-700 transition-colors">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
            Add Hike
        </a>
    </div>
</div>

<!-- Map + Sidebar -->
<div id="map-container">
    <div id="all-hikes-map" class="z-0"></div>

    <div id="hike-sidebar">
        <div id="hike-sidebar-header">
            <h2>Hikes in view</h2>
            <span id="visible-count"></span>
        </div>
        <div id="hike-list"></div>
        <div id="empty-state">
            <svg class="w-8 h-8 text-gray-300 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z"/>
            </svg>
            <p class="text-sm text-gray-400 font-medium">No hikes here</p>
            <p class="text-xs text-gray-400 mt-0.5">Pan or zoom out to find trails</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mark the map container so the base CSS height override doesn't clobber the flex height
    document.getElementById('all-hikes-map').querySelector && (function() {
        var observer = new MutationObserver(function(mutations, obs) {
            var lc = document.querySelector('#all-hikes-map .leaflet-container');
            if (lc) { lc.classList.add('no-default-height'); obs.disconnect(); }
        });
        observer.observe(document.getElementById('all-hikes-map'), { childList: true, subtree: true });
    })();

    var map = L.map('all-hikes-map').setView([49.8175, 15.4730], 7);

    L.tileLayer('{{ tile_url }}', {
        attribution: '{{ tile_attribution|safe }}',
        maxZoom: 19
    }).addTo(map);

    var hikeData = {{ hike_markers | tojson }};
    var routeColors = ['#2d7e41','#c17f22','#1e40af','#9333ea','#dc2626','#0891b2','#4f46e5','#be185d'];
    var allBounds = [];

    /* Per-hike lookup: id -> { routeLayer, marker, bounds, color, cardEl } */
    var hikeLayers = {};

    var difficultyIcon = { 'Easy': 'ðŸŸ¢', 'Medium': 'ðŸŸ¡', 'Hard': 'ðŸ”´' };

    var listEl = document.getElementById('hike-list');

    hikeData.forEach(function(h, idx) {
        var color = routeColors[idx % routeColors.length];
        var entry = { color: color, bounds: null, routeLayer: null, marker: null, cardEl: null };

        /* â”€â”€ Map layers â”€â”€ */
        if (h.route) {
            /* White casing outline for contrast against busy map tiles */
            entry.casingLayer = L.geoJSON(h.route, {
                style: { color: '#fff', weight: 8, opacity: 0.6, lineCap: 'round', lineJoin: 'round' },
                interactive: false
            }).addTo(map);
            /* Colored route on top */
            entry.routeLayer = L.geoJSON(h.route, {
                style: { color: color, weight: 5, opacity: 0.9, lineCap: 'round', lineJoin: 'round' }
            }).addTo(map);
            entry.routeLayer.bindPopup(
                '<div class="text-sm">' +
                '<a href="/hikes/' + h.id + '" class="font-bold text-forest-700 hover:underline">' + h.title + '</a>' +
                '<div class="text-gray-500 mt-1">' +
                (h.distance ? h.distance + ' km' : '') +
                (h.elevation_gain ? ' Â· ' + h.elevation_gain + 'mâ†‘' : '') +
                (h.difficulty ? ' Â· ' + h.difficulty : '') +
                '</div></div>'
            );
            entry.bounds = entry.routeLayer.getBounds();
            allBounds.push(entry.bounds);
        }

        if (h.start) {
            entry.marker = L.circleMarker(h.start, {
                radius: 8, fillColor: color, fillOpacity: 1,
                color: '#fff', weight: 3
            }).addTo(map);
            entry.marker.bindPopup(
                '<a href="/hikes/' + h.id + '" class="font-bold text-forest-700 hover:underline text-sm">' + h.title + '</a>'
            );
            if (!entry.bounds) {
                entry.bounds = L.latLngBounds(h.start, h.start);
                allBounds.push(entry.bounds);
            }
        }

        /* Map layer hover â†’ highlight sidebar card */
        function onMapHover() { highlightHike(h.id); }
        function onMapUnhover() { unhighlightHike(h.id); }
        if (entry.routeLayer) {
            entry.routeLayer.on('mouseover', onMapHover);
            entry.routeLayer.on('mouseout', onMapUnhover);
        }
        if (entry.marker) {
            entry.marker.on('mouseover', onMapHover);
            entry.marker.on('mouseout', onMapUnhover);
        }

        /* â”€â”€ Sidebar card â”€â”€ */
        var card = document.createElement('div');
        card.className = 'hike-card';
        card.dataset.hikeId = h.id;

        var badges = [];
        if (h.distance) badges.push(h.distance + ' km');
        if (h.elevation_gain) badges.push(h.elevation_gain + 'mâ†‘');
        if (h.estimated_time) badges.push(h.estimated_time);

        var diffLabel = h.difficulty ? (difficultyIcon[h.difficulty] || '') + ' ' + h.difficulty : '';

        card.innerHTML =
            '<div class="color-dot" style="background:' + color + '"></div>' +
            '<div class="card-body">' +
                '<div class="card-title">' + h.title + '</div>' +
                (h.start_name || h.end_name ? '<div class="card-location">' + [h.start_name, h.end_name].filter(Boolean).join(' â†’ ') + '</div>' : '') +
                (badges.length || diffLabel ? '<div class="card-meta">' +
                    (diffLabel ? '<span>' + diffLabel + '</span>' : '') +
                    (diffLabel && badges.length ? '<span style="color:#e5e1da">Â·</span>' : '') +
                    badges.join('<span style="color:#e5e1da"> Â· </span>') +
                '</div>' : '') +
            '</div>' +
            '<svg class="card-arrow w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>';

        /* Sidebar hover â†’ highlight on map */
        card.addEventListener('mouseenter', function() { highlightHike(h.id); });
        card.addEventListener('mouseleave', function() { unhighlightHike(h.id); });

        /* Click â†’ open hike detail */
        card.addEventListener('click', function() {
            window.location.href = '/hikes/' + h.id;
        });

        listEl.appendChild(card);
        entry.cardEl = card;
        hikeLayers[h.id] = entry;
    });

    /* â”€â”€ Highlight / unhighlight â”€â”€ */
    function highlightHike(id) {
        var e = hikeLayers[id];
        if (!e) return;
        if (e.casingLayer) e.casingLayer.setStyle({ weight: 12, opacity: 0.8 });
        if (e.routeLayer) e.routeLayer.setStyle({ weight: 7, opacity: 1 });
        if (e.marker) e.marker.setRadius(11);
        if (e.cardEl) e.cardEl.classList.add('highlighted');
    }
    function unhighlightHike(id) {
        var e = hikeLayers[id];
        if (!e) return;
        if (e.casingLayer) e.casingLayer.setStyle({ weight: 8, opacity: 0.6 });
        if (e.routeLayer) e.routeLayer.setStyle({ weight: 5, opacity: 0.9 });
        if (e.marker) e.marker.setRadius(8);
        if (e.cardEl) e.cardEl.classList.remove('highlighted');
    }

    /* â”€â”€ Filter sidebar by map viewport â”€â”€ */
    function updateVisibleHikes() {
        var mapBounds = map.getBounds();
        var visibleCount = 0;

        hikeData.forEach(function(h) {
            var entry = hikeLayers[h.id];
            if (!entry || !entry.cardEl) return;

            var visible = false;
            if (entry.bounds) {
                visible = mapBounds.intersects(entry.bounds);
            } else if (h.start) {
                visible = mapBounds.contains(L.latLng(h.start[0], h.start[1]));
            }

            if (visible) {
                entry.cardEl.classList.remove('hidden-viewport');
                visibleCount++;
            } else {
                entry.cardEl.classList.add('hidden-viewport');
            }
        });

        document.getElementById('visible-count').textContent =
            visibleCount + ' / ' + hikeData.length;
        document.getElementById('empty-state').style.display = visibleCount === 0 ? 'block' : 'none';
    }

    map.on('moveend', updateVisibleHikes);
    map.on('zoomend', updateVisibleHikes);

    /* â”€â”€ Fit all hikes â”€â”€ */
    if (allBounds.length) {
        var combined = allBounds[0];
        for (var i = 1; i < allBounds.length; i++) {
            combined.extend(allBounds[i]);
        }
        map.fitBounds(combined, { padding: [40, 40] });
    }

    /* Initial sidebar update once map settles */
    setTimeout(updateVisibleHikes, 300);
});
</script>
{% endblock %}
