{% extends "base.html" %}

{% block title %}{{ hike.title }} - Hike Guide{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="/hikes" class="text-sm font-medium text-green-600 hover:text-green-500">&larr; Back to all hikes</a>
</div>

<div class="lg:grid lg:grid-cols-2 lg:gap-x-8">
    <!-- Hike Info -->
    <div>
        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">{{ hike.title }}</h1>
        <div class="mt-4 flex items-center gap-x-4 text-sm text-gray-500">
            <span>{{ hike.distance }} km</span>
            <span>&bull;</span>
            <span>{{ hike.elevation_gain }}m elevation</span>
            <span>&bull;</span>
            <span
                class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">{{
                hike.difficulty }}</span>
        </div>

        <div class="mt-6 space-y-6 text-base text-gray-700">
            <p>{{ hike.description or "No description provided." }}</p>
        </div>

        <div class="mt-10 border-t border-gray-200 pt-10">
            <h3 class="text-lg font-medium text-gray-900">Photos</h3>

            <!-- Photo Gallery -->
            <div class="mt-4 grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
                {% for photo in hike.photos %}
                <div class="relative group aspect-square bg-gray-100 rounded-lg overflow-hidden">
                    <img src="/static/uploads/{{ photo.filename }}" alt="{{ photo.caption or 'Hike photo' }}"
                        class="object-cover w-full h-full group-hover:opacity-75">
                    {% if photo.caption %}
                    <div
                        class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 truncate">
                        {{ photo.caption }}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-500 col-span-full">No photos yet. Be the first to share one!</p>
                {% endfor %}
            </div>

            <!-- Upload Form -->
            <form action="/hikes/{{ hike.id }}/photos" method="POST" enctype="multipart/form-data" class="mt-6">
                <label class="block text-sm font-medium text-gray-700">Add a photo</label>
                <div class="mt-2 flex items-center gap-x-3">
                    <input type="file" name="photo_file" accept="image/*" required
                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    <input type="text" name="caption" placeholder="Caption (optional)"
                        class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-green-600 sm:text-sm sm:leading-6">
                    <button type="submit"
                        class="rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Upload</button>
                </div>
            </form>

            <h3 class="mt-10 text-lg font-medium text-gray-900">Ratings & Reviews</h3>

            <div class="mt-4 space-y-4">
                {% for rating in hike.ratings %}
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="flex text-yellow-400">
                                {% for i in range(rating.rating) %}★{% endfor %}
                                {% for i in range(5 - rating.rating) %}<span class="text-gray-300">★</span>{% endfor %}
                            </div>
                            <span class="ml-2 text-sm font-medium text-gray-900">{{ rating.user.username }}</span>
                        </div>
                        <span class="text-sm text-gray-500">{{ rating.created_at.strftime('%Y-%m-%d') }}</span>
                    </div>
                    {% if rating.comment %}
                    <p class="mt-2 text-sm text-gray-700">{{ rating.comment }}</p>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-500">No reviews yet.</p>
                {% endfor %}
            </div>

            <!-- Rating Form -->
            <form action="/hikes/{{ hike.id }}/ratings" method="POST" class="mt-6 bg-gray-50 p-4 rounded-lg">
                <h4 class="text-sm font-medium text-gray-900">Write a review</h4>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Rating</label>
                    <div class="mt-1 flex items-center space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="rating" value="5" checked
                                class="text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm">5 ★</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="rating" value="4" class="text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm">4 ★</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="rating" value="3" class="text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm">3 ★</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="rating" value="2" class="text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm">2 ★</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="rating" value="1" class="text-green-600 focus:ring-green-500">
                            <span class="ml-2 text-sm">1 ★</span>
                        </label>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="comment" class="block text-sm font-medium text-gray-700">Comment</label>
                    <div class="mt-1">
                        <textarea id="comment" name="comment" rows="3"
                            class="block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-green-600 sm:text-sm sm:leading-6"></textarea>
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button type="submit"
                        class="rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600">Submit
                        Review</button>
                </div>
            </form>

            <!-- Map Container -->
            <div class="mt-10 lg:mt-0">
                <div id="hike-map" class="rounded-lg shadow-inner h-96 border border-gray-200 z-0"></div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Default to Prague/Czechia center
                var map = L.map('hike-map').setView([49.8175, 15.4730], 7);

                // Mapy.cz Tiles (using generic OSM for now as Mapy.cz requires API key for pure tiles or special config)
                // Actually, Mapy.cz generic tiles can be accessed via:
                // https://mapserver.mapy.cz/turist-m/{z}-{x}-{y}
                // But let's stick to OSM for simplicity first, or OpenTopoMap which looks hike-y.
                // Using Mapy.cz tourist layer directly (unofficial endpoint, often used):
                L.tileLayer('https://m{s}.mapserver.mapy.cz/turist-m/{z}-{x}-{y}.png', {
                    attribution: '&copy; <a href="https://www.seznam.cz" target="_blank">Seznam.cz, a.s.</a>, &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
                    maxZoom: 18,
                    subdomains: '1234'
                }).addTo(map);

                // Load route GeoJSON
                var routeData = {{ route_json | safe if route_json else 'null'
            }};
            if (routeData) {
                var routeLayer = L.geoJSON(routeData).addTo(map);
                map.fitBounds(routeLayer.getBounds());
            }
            });
        </script>
        {% endblock %}