{% extends "base.html" %}

{% block title %}Add New Hike - Hike Guide{% endblock %}

{% block head %}
<style>
    .tree-sway   { animation: nat-sway 5s ease-in-out infinite; transform-origin: bottom center; }
    .tree-sway-2 { animation: nat-sway 4s ease-in-out infinite 0.9s; transform-origin: bottom center; }
    .bird-form   { animation: nat-fly 7s ease-in-out infinite; }
    .feather-form { animation: nat-drift 4.5s ease-in-out infinite; }
    @keyframes nat-sway  { 0%,100%{transform:rotate(0deg)} 30%{transform:rotate(1.5deg)} 70%{transform:rotate(-1deg)} }
    @keyframes nat-fly   { 0%,100%{transform:translate(0,0)} 40%{transform:translate(10px,-6px)} 70%{transform:translate(20px,-2px)} }
    @keyframes nat-drift { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(5px) rotate(-10deg)} }
</style>
{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto relative">
    <!-- Decorative elements -->
    <!-- Spruce tree top-right -->
    <svg class="absolute -top-2 -right-20 w-14 h-36 text-forest-700/[0.07] tree-sway hidden lg:block pointer-events-none" viewBox="0 0 60 160" fill="currentColor">
        <polygon points="30,0 12,42 48,42"/>
        <polygon points="30,28 8,68 52,68"/>
        <polygon points="30,54 4,98 56,98"/>
        <polygon points="30,82 0,130 60,130"/>
        <rect x="25" y="128" width="10" height="32" rx="2"/>
    </svg>
    <!-- Shorter spruce bottom-left -->
    <svg class="absolute bottom-16 -left-16 w-10 h-24 text-forest-700/[0.05] tree-sway-2 hidden lg:block pointer-events-none" viewBox="0 0 60 160" fill="currentColor">
        <polygon points="30,10 14,48 46,48"/>
        <polygon points="30,36 10,74 50,74"/>
        <polygon points="30,62 6,106 54,106"/>
        <polygon points="30,92 2,138 58,138"/>
        <rect x="25" y="136" width="10" height="24" rx="2"/>
    </svg>
    <!-- Bird in flight -->
    <svg class="absolute top-16 -right-8 w-6 h-3 text-gray-500/20 bird-form hidden lg:block pointer-events-none" viewBox="0 0 32 16" fill="currentColor">
        <path d="M16,8 C14,4 8,1 2,4 C6,6 10,6 16,8 Z"/>
        <path d="M16,8 C18,4 24,1 30,4 C26,6 22,6 16,8 Z"/>
    </svg>
    <!-- Feather -->
    <svg class="absolute top-32 -left-12 w-3 h-7 text-amber-600/15 feather-form hidden lg:block pointer-events-none" viewBox="0 0 20 48" fill="currentColor">
        <path d="M10,0 C10,0 18,8 18,20 C18,32 14,40 10,48 C10,48 10,40 8,32 C6,24 2,16 2,8 C2,4 6,0 10,0 Z"/>
        <line x1="10" y1="2" x2="10" y2="46" stroke="currentColor" stroke-width="0.8" opacity="0.4"/>
    </svg>

    <!-- Header -->
    <div class="mb-8">
        <a href="/hikes" class="inline-flex items-center gap-1.5 text-sm font-medium text-forest-600 hover:text-forest-800 transition-colors mb-4">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
            Back to hikes
        </a>
        <h1 class="font-display text-3xl font-extrabold tracking-tight text-gray-900">Add New Hike</h1>
        <p class="mt-1 text-sm text-gray-500">Paste a Mapy.com link or upload a GPX file — everything else is computed automatically.</p>
    </div>

    <form action="/hikes/new" method="POST" enctype="multipart/form-data" class="space-y-6">

        <!-- Title -->
        <div class="bg-white rounded-2xl ring-1 ring-sand-200 shadow-sm p-6">
            <label for="title" class="block text-sm font-semibold text-gray-700 mb-1.5">Title</label>
            <input type="text" name="title" id="title" required placeholder="e.g. Sněžka Summit Loop"
                   class="block w-full rounded-xl border-0 py-2.5 px-3.5 text-gray-900 shadow-sm ring-1 ring-inset ring-sand-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-forest-500 text-sm">
        </div>

        <!-- Route Source (tabs: URL / GPX) -->
        <div class="bg-white rounded-2xl ring-1 ring-sand-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-sand-100 bg-sand-50/50">
                <h2 class="font-display font-bold text-base text-gray-900">Route Source</h2>
                <p class="text-xs text-gray-400 mt-0.5">Provide one of the two options below</p>
            </div>
            <div class="p-6 space-y-5">

                <!-- Mapy.com URL -->
                <div>
                    <label for="mapy_url" class="block text-sm font-semibold text-gray-700 mb-1.5">Mapy.com Link</label>
                    <input type="url" name="mapy_url" id="mapy_url" placeholder="https://mapy.com/s/kujomepoco"
                           class="block w-full rounded-xl border-0 py-2.5 px-3.5 text-gray-900 shadow-sm ring-1 ring-inset ring-sand-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-forest-500 text-sm">
                    <p class="mt-1.5 text-xs text-gray-400">Paste any mapy.com link — short links like <code class="bg-sand-100 px-1 rounded">mapy.com/s/...</code> work too</p>
                    <!-- Status indicator -->
                    <div id="url-status" class="hidden mt-2 flex items-center gap-2 text-sm">
                        <div id="url-spinner" class="hidden w-4 h-4 border-2 border-forest-300 border-t-forest-600 rounded-full animate-spin"></div>
                        <span id="url-status-text"></span>
                    </div>
                </div>

                <!-- Divider -->
                <div class="relative">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-sand-200"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-3 text-xs font-medium text-gray-400 uppercase tracking-wider">or</span></div>
                </div>

                <!-- GPX Upload -->
                <div>
                    <label for="gpx_file" class="block text-sm font-semibold text-gray-700 mb-1.5">GPX File</label>
                    <input type="file" name="gpx_file" id="gpx_file" accept=".gpx"
                           class="block w-full text-sm text-gray-600 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-forest-50 file:text-forest-700 file:font-semibold file:text-sm hover:file:bg-forest-100 file:cursor-pointer cursor-pointer">
                </div>
            </div>
        </div>

        <!-- Description (optional) -->
        <div class="bg-white rounded-2xl ring-1 ring-sand-200 shadow-sm p-6">
            <label for="description" class="block text-sm font-semibold text-gray-700 mb-1.5">Description <span class="font-normal text-gray-400">(optional)</span></label>
            <textarea id="description" name="description" rows="3" placeholder="Trail conditions, highlights, tips..."
                      class="block w-full rounded-xl border-0 py-2.5 px-3.5 text-gray-900 shadow-sm ring-1 ring-inset ring-sand-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-forest-500 text-sm"></textarea>
        </div>

        <!-- Country -->
        <div class="bg-white rounded-2xl ring-1 ring-sand-200 shadow-sm p-6">
            <label for="country" class="block text-sm font-semibold text-gray-700 mb-1.5">Country <span class="font-normal text-gray-400">(optional)</span></label>
            <input type="text" name="country" id="country" placeholder="e.g. Czech Republic"
                   class="block w-full rounded-xl border-0 py-2.5 px-3.5 text-gray-900 shadow-sm ring-1 ring-inset ring-sand-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-forest-500 text-sm">
        </div>

        <!-- Hidden fields populated by URL resolver -->
        <input type="hidden" name="start_lon" id="start_lon">
        <input type="hidden" name="start_lat" id="start_lat">
        <input type="hidden" name="end_lon" id="end_lon">
        <input type="hidden" name="end_lat" id="end_lat">
        <input type="hidden" name="start_location" id="start_location">
        <input type="hidden" name="end_location" id="end_location">
        <input type="hidden" name="route_type" id="route_type" value="foot_hiking">
        <input type="hidden" name="mapset" id="mapset" value="outdoor">

        <!-- Actions -->
        <div class="relative pb-4">
            <!-- Subtle pine branch divider -->
            <div class="flex justify-center mb-5 opacity-[0.12]">
                <svg class="w-32 h-4 text-forest-600" viewBox="0 0 120 16" fill="none" stroke="currentColor" stroke-width="1">
                    <path d="M10,8 L110,8" stroke-dasharray="1,4"/>
                    <path d="M30,8 L22,3 M30,8 L22,13" stroke-width="1.2"/>
                    <path d="M60,8 L52,2 M60,8 L52,14" stroke-width="1.2"/>
                    <path d="M90,8 L82,3 M90,8 L82,13" stroke-width="1.2"/>
                </svg>
            </div>
            <div class="flex items-center justify-end gap-4">
            <a href="/hikes" class="text-sm font-semibold text-gray-500 hover:text-gray-700 transition-colors">Cancel</a>
            <button type="submit" id="submit-btn"
                    class="inline-flex items-center gap-2 rounded-xl bg-forest-600 px-6 py-2.5 text-sm font-bold text-white shadow-sm hover:bg-forest-700 disabled:opacity-60 disabled:cursor-not-allowed transition-colors">
                <svg id="submit-icon" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/></svg>
                <svg id="submit-spinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                <span id="submit-label">Save Hike</span>
            </button>
            </div>
        </div>
    </form>
</div>

<script>
    const mapyUrlInput = document.getElementById('mapy_url');
    const urlStatus = document.getElementById('url-status');
    const urlSpinner = document.getElementById('url-spinner');
    const urlStatusText = document.getElementById('url-status-text');
    let resolveTimeout = null;

    function showStatus(msg, type) {
        urlStatus.classList.remove('hidden');
        urlSpinner.classList.add('hidden');
        urlStatusText.textContent = msg;
        urlStatusText.className = type === 'ok'
            ? 'text-forest-600 font-medium'
            : type === 'warn'
            ? 'text-amber-600 font-medium'
            : 'text-red-500 font-medium';
    }

    function showLoading() {
        urlStatus.classList.remove('hidden');
        urlSpinner.classList.remove('hidden');
        urlStatusText.textContent = 'Resolving link...';
        urlStatusText.className = 'text-gray-500';
    }

    // Submit loading state
    document.querySelector('form').addEventListener('submit', function() {
        var btn = document.getElementById('submit-btn');
        btn.disabled = true;
        document.getElementById('submit-icon').classList.add('hidden');
        document.getElementById('submit-spinner').classList.remove('hidden');
        document.getElementById('submit-label').textContent = 'Saving…';
    });

    mapyUrlInput.addEventListener('input', () => {
        clearTimeout(resolveTimeout);
        const url = mapyUrlInput.value.trim();
        if (!url) {
            urlStatus.classList.add('hidden');
            return;
        }
        if (!url.startsWith('http')) return;

        showLoading();
        resolveTimeout = setTimeout(async () => {
            try {
                const resp = await fetch(`/hikes/mapy/resolve-url?url=${encodeURIComponent(url)}`);
                if (!resp.ok) {
                    showStatus('Could not resolve this link', 'error');
                    return;
                }
                const data = await resp.json();

                // Duplicate detection warning
                if (data.duplicate) {
                    showStatus(`⚠️ Duplicate — this URL is already saved as "${data.duplicate.title}"`, 'warn');
                    const dupLink = document.createElement('a');
                    dupLink.href = `/hikes/${data.duplicate.id}`;
                    dupLink.textContent = 'View existing hike →';
                    dupLink.className = 'ml-2 underline text-amber-700 hover:text-amber-900';
                    urlStatusText.appendChild(dupLink);
                }

                if (data.start) {
                    document.getElementById('start_lon').value = data.start[0];
                    document.getElementById('start_lat').value = data.start[1];
                    if (data.start_name) document.getElementById('start_location').value = data.start_name;
                }
                if (data.end) {
                    document.getElementById('end_lon').value = data.end[0];
                    document.getElementById('end_lat').value = data.end[1];
                    if (data.end_name) document.getElementById('end_location').value = data.end_name;
                }
                // For short/legacy URLs: use center as the location
                if (data.center && !data.start) {
                    document.getElementById('start_lon').value = data.center[0];
                    document.getElementById('start_lat').value = data.center[1];
                    if (data.center_name) document.getElementById('start_location').value = data.center_name;
                }
                if (data.routeType) document.getElementById('route_type').value = data.routeType;
                if (data.mapset) document.getElementById('mapset').value = data.mapset;

                // Build user-friendly status
                if (data.type === 'route' && data.start && data.end) {
                    const names = [data.start_name, data.end_name].filter(Boolean);
                    let label = 'Route imported';
                    if (data.dim_title) {
                        label += ': ' + data.dim_title;
                    } else if (names.length) {
                        label += ': ' + names.join(' → ');
                    }
                    if (data.route_points_count) {
                        label += ' (' + data.route_points_count + ' points)';
                    }
                    if (data.totalLength) {
                        label += ' · ' + (data.totalLength / 1000).toFixed(1) + ' km';
                    }
                    showStatus(label, 'ok');
                    // Auto-fill title if empty and we have a dim_title
                    const titleInput = document.getElementById('title');
                    if (data.dim_title && !titleInput.value.trim()) {
                        titleInput.value = data.dim_title;
                    }
                } else if (data.center) {
                    const name = data.center_name || data.start_name || '';
                    showStatus('Location imported' + (name ? ': ' + name : ''), 'ok');
                } else if (data.start) {
                    const name = data.start_name || '';
                    showStatus('Location imported' + (name ? ': ' + name : ''), 'ok');
                } else {
                    showStatus('Link resolved', 'ok');
                }
            } catch (e) {
                showStatus('Could not resolve this link', 'error');
            }
        }, 500);
    });
</script>
{% endblock %}